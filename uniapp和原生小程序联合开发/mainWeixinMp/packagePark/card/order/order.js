require('../../common/vendor.js');(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["packagePark/card/order/order"],{"0149":function(e,t,a){"use strict";(function(e){var i=a("4ea4");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=i(a("9523")),r=i(a("60e9")),d=i(a("7504")),o={data:function(){var e;return e={tenantId:d.default.tenantId,cardId:"",cardBillId:"",startTime:"",endTime:"",fareRuleId:"",amountPaid:"",parkName:"",plateNumber:""},(0,n.default)(e,"fareRuleId",""),(0,n.default)(e,"startDateBegin",""),(0,n.default)(e,"endDateBegin",""),(0,n.default)(e,"startDate",""),(0,n.default)(e,"endDate",""),(0,n.default)(e,"chargeType",""),(0,n.default)(e,"monthPrice",""),(0,n.default)(e,"dayPrice",""),(0,n.default)(e,"payData",{}),(0,n.default)(e,"deleteCardBillId",""),e},onLoad:function(e){this.cardId=e.cardId,this.cardBillId=e.cardBillId,this.getDetailData()},methods:{getDetailData:function(){var e=this;this.$httpPark.get("cardBill/app/".concat(this.cardBillId)).then((function(t){console.log("res: ",t);t.id;var a=t.parkName,i=t.plateNumber,n=t.endTime,d=(t.startTime,t.amountPaid,t.fareRuleId),o=t.appCode,s=t.payCallbackUrl;e.endDateBegin=e.startDateBegin=e.startTime=(0,r.default)(n).add(1,"days").format("YYYY-MM-DD"),e.parkName=a,e.plateNumber=i,e.fareRuleId=d,e.payData={appCode:o,payCallbackUrl:s}}))},bindStChange:function(e){var t=e.target.value;this.endTime?(0,r.default)(t).diff(this.endTime,"seconds")>0?this.error("开始日期应早于结束日期"):(this.startTime=t,this.getRule()):this.startTime=t},bindTsChange:function(e){var t=e.target.value;this.startTime?(console.log("date: ",(0,r.default)(t).diff(this.startTime,"seconds")),(0,r.default)(t).diff(this.startTime,"seconds")<0?this.error("结束日期应晚于开始日期"):(this.endTime=t,this.getRule())):this.endTime=t},error:function(t){e.showToast({title:t||"异常",icon:"none"})},calculateCost:function(){var e=(0,r.default)(this.startTime).startOf("day"),t=(0,r.default)(this.endTime).add(1,"days").endOf("day"),a=Math.abs(e.diff(t,"months")),i=void 0;if(a>=1?i=Math.abs(e.add(a,"months").diff(t,"days")):(i=Math.abs(e.add(a,"months").diff(t,"days")),a=0),0===this.chargeType){var n=0;n+=a<=0?0:a*this.monthPrice,n+=i<=0?0:i*this.dayPrice,this.amountPaid=n}else if(1===this.chargeType){var d=0;a<=0?d=d:d+=a*this.monthPrice,i<=0?d=d:d+=this.monthPrice,this.amountPaid=d}},getRule:function(){var t=this,a=this,i="/fareRule/"+a.fareRuleId;a.$httpPark.get(i).then((function(i){1==i.failed?e.showToast({title:i.message,icon:"none"}):(a.chargeType=i.chargeType,a.monthPrice=i.monthPrice,a.dayPrice=i.dayPrice,t.calculateCost())})).catch((function(t){e.showToast({title:res.message,icon:"none"})}))},pay:function(){var t=this;if(!this.endTime)return this.error("请选择结束日期");e.showLoading(),this.$httpPark.post("/cardBill/renew/app",{cardId:this.cardId,startTime:(0,r.default)(this.startTime).startOf("day").format("YYYY-MM-DD HH:mm:ss"),endTime:(0,r.default)(this.endTime).endOf("day").format("YYYY-MM-DD HH:mm:ss"),fareRuleId:this.fareRuleId,amountPaid:this.amountPaid}).then((function(a){if(a.failed)return e.showToast({title:a.message,icon:"none"});t.payData.payCallbackUrl=a.backUrl,t.deleteCardBillId=a.cardBillId,e.hideLoading(),t.requestWxPay()})).catch((function(){e.hideLoading()}))},requestWxPay:function(){var t=this,a={tenantId:this.tenantId,appCode:this.payData.appCode,channelCode:"WECHAT_MP",goodsList:[{goodsName:"车牌"+this.plateNumber+"包月续费",goodsCode:"BYXF",goodsFee:this.amountPaid}],orderDescribe:"临停缴费",goodsTotalFee:this.amountPaid,sourceBiz:"NOVA_PARK",bizNotifyUrl:this.payData.payCallbackUrl+"?payWayId=1"};e.showLoading({title:"加载中"});this.$httpPark.request(d.default.apiBaseUrl+"/npay/v1/unifiedOrder",a,{method:"POST"}).then((function(a){if(console.log("res: ",a),a)if(a.failed)e.showToast({title:"发起支付失败",icon:"none"});else{var i=a.goodsOrder,n=a.params;e.requestPayment({provider:"wxpay",timeStamp:n.timeStamp,signType:n.signType,package:n.package,paySign:n.paySign,nonceStr:n.nonceStr,success:function(t){e.navigateTo({url:"../pay/success/success?orderNo=".concat(i.orderNo,"&amount=").concat(i.goodsTotalFee)})},fail:function(a){var i=a.errMsg;if(i&&i.includes("cancel"))return t.$httpPark.delete("/cardBill/".concat(t.deleteCardBillId)),e.showToast({title:"支付取消",icon:"none"});e.navigateTo({url:"../pay/fail/fail"})}})}})).finally((function(){return e.hideLoading()}))}}};t.default=o}).call(this,a("543d")["default"])},4407:function(e,t,a){"use strict";(function(e,t){var i=a("4ea4");a("895d");i(a("66fd"));var n=i(a("836f"));e.__webpack_require_UNI_MP_PLUGIN__=a,t(n.default)}).call(this,a("bc2e")["default"],a("543d")["createPage"])},"836f":function(e,t,a){"use strict";a.r(t);var i=a("c317"),n=a("aede");for(var r in n)["default"].indexOf(r)<0&&function(e){a.d(t,e,(function(){return n[e]}))}(r);a("c069");var d=a("f0c5"),o=Object(d["a"])(n["default"],i["b"],i["c"],!1,null,"6c4a134c",null,!1,i["a"],void 0);t["default"]=o.exports},aede:function(e,t,a){"use strict";a.r(t);var i=a("0149"),n=a.n(i);for(var r in i)["default"].indexOf(r)<0&&function(e){a.d(t,e,(function(){return i[e]}))}(r);t["default"]=n.a},bb88:function(e,t,a){},c069:function(e,t,a){"use strict";var i=a("bb88"),n=a.n(i);n.a},c317:function(e,t,a){"use strict";a.d(t,"b",(function(){return n})),a.d(t,"c",(function(){return r})),a.d(t,"a",(function(){return i}));var i={uniIcons:function(){return Promise.all([a.e("common/vendor"),a.e("uni_modules/uni-icons/components/uni-icons/uni-icons")]).then(a.bind(null,"cff5"))}},n=function(){var e=this.$createElement,t=(this._self._c,(this.amountPaid/100).toFixed(2));this.$mp.data=Object.assign({},{$root:{g0:t}})},r=[]}},[["4407","common/runtime","common/vendor","packagePark/common/vendor"]]]);